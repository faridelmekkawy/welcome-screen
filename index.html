<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"/>
  <title>Welcome Display — Soueast</title>
  <link rel="icon" href="https://cdn.jsdelivr.net/gh/faridelmekkawy/welcome-screen@4a8adbb28a506932c49d23d008f82c420d9191d3/public/welcome.png"/>
  <style>
    :root{
      --fade:.35s;
      --ink:#fff;
      --veil:linear-gradient(180deg, rgba(0,0,0,.25), rgba(0,0,0,.85));
      --img-url:url("https://cdn.jsdelivr.net/gh/faridelmekkawy/welcome-screen@4a8adbb28a506932c49d23d008f82c420d9191d3/public/welcome.png");

      /* Black-bar hitbox (tuned) */
      --box-top: 50.5%;
      --box-height: 10.2%;
      --box-left: 6%;
      --box-right: 6%;
    }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;background:#000;color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial}
    .stage{position:fixed;inset:0;overflow:hidden}

    /* Video layer */
    .video{position:absolute;inset:0;transition:opacity var(--fade) ease}
    .video.hidden{opacity:0;pointer-events:none}
    video{position:absolute;inset:0;width:100%;height:100%;object-fit:cover;background:#000}

    /* Prefer full frame on wide screens (less cropping / better quality) */
    @media (min-aspect-ratio: 16/10){
      video{ object-fit: contain; background:#000; }
    }

    /* Overlay (PNG + name) */
    .overlay{
      position:absolute;inset:0;display:grid;place-items:center;
      background:var(--veil);opacity:0;pointer-events:none;transition:opacity var(--fade) ease;
    }
    .overlay.visible{opacity:1;pointer-events:auto}

    .frame{
      width:clamp(260px,70vmin,920px);
      aspect-ratio:768/1365;
      background:center/cover no-repeat var(--img-url);
      position:relative;
      border-radius:22px;
      box-shadow:0 24px 96px rgba(0,0,0,.55);
    }
    .name-box{
      position:absolute;
      left:var(--box-left); right:var(--box-right);
      top:var(--box-top);   height:var(--box-height);
      display:flex;align-items:center;justify-content:center;
      padding:.3rem .8rem;
    }
    /* Toggle this for alignment debugging: .name-box.debug { outline:3px dashed #00ff91; outline-offset:-2px } */

    .name{
      width:100%;
      text-align:center; font-weight:900; letter-spacing:.02em; text-transform:uppercase;
      color:#fff; text-shadow:0 3px 14px rgba(0,0,0,.55);
      /* keep on one line inside the bar; JS shrinks if needed */
      white-space:nowrap; overflow:hidden;
      line-height:1.05;
      font-size:clamp(20px,7.5vmin,84px);
    }

    .status{position:fixed;left:10px;bottom:10px;font:12px ui-monospace,monospace;opacity:.85;color:#0ff}

    /* Phone-portrait: tiny nudge */
    @media (max-width:600px) and (max-aspect-ratio: 9/16){
      :root{ --box-top: 51.5%; --box-height: 10.6%; }
    }
    /* Very wide laptops/TVs */
    @media (min-aspect-ratio: 16/9){
      :root{ --box-top: 49.8%; --box-height: 9.6%; }
    }
  </style>
</head>
<body>
  <div class="stage">
    <!-- Background video -->
    <div class="video" id="videoWrap">
      <video id="bgVideo" autoplay muted loop playsinline preload="auto"
        poster="https://cdn.jsdelivr.net/gh/faridelmekkawy/welcome-screen@4a8adbb28a506932c49d23d008f82c420d9191d3/public/welcome.png">
        <source src="https://cdn.jsdelivr.net/gh/faridelmekkawy/welcome-screen@4a8adbb28a506932c49d23d008f82c420d9191d3/public/welcome.mp4" type="video/mp4"/>
      </video>
    </div>

    <!-- Overlay -->
    <div class="overlay" id="overlay">
      <div class="frame">
        <div class="name-box"><div class="name" id="nameEl">GUEST</div></div>
      </div>
    </div>
  </div>

  <div class="status" id="status">state: video • initializing…</div>

  <!-- Firebase compat SDKs -->
  <script src="https://www.gstatic.com/firebasejs/11.0.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/11.0.2/firebase-database-compat.js"></script>

  <script>
    /* ===== Config ===== */
    const SHOW_MS = 10000;
    const EVENT_ID = "Soueast";
    const WATCH_NAME = `events/${EVENT_ID}/welcome/latest/name`;   // string name
    // If you can add a timestamp in your scanner, also write latest/ts and swap to WATCH_OBJ below
    // const WATCH_OBJ  = `events/${EVENT_ID}/welcome/latest`;      // { name, ts }

    const firebaseConfig = {
      apiKey: "AIzaSyA80bAAGPuyscnTVS-zwrxE9Jp3tPiS1gM",
      authDomain: "events-339ce.firebaseapp.com",
      databaseURL: "https://events-339ce-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "events-339ce",
      storageBucket: "events-339ce.appspot.com",
      messagingSenderId: "175601544315",
      appId: "1:175601544315:web:00c94b4affa972b3a286de"
    };
    firebase.initializeApp(firebaseConfig);

    /* ===== Elements ===== */
    const db = firebase.database();
    const statusEl = document.getElementById("status");
    const videoWrap = document.getElementById("videoWrap");
    const overlay = document.getElementById("overlay");
    const nameEl = document.getElementById("nameEl");
    const bgVideo = document.getElementById("bgVideo");
    const showStatus = msg => statusEl.textContent = msg;

    /* ===== First-name only ===== */
    function firstNameOf(full=""){
      const t = String(full).trim();
      if (!t) return "GUEST";
      // pick first word (supports basic latin & arabic letters)
      const m = t.match(/[A-Za-z\u0600-\u06FF]+(?:'[A-Za-z]+)?/);
      return (m ? m[0] : t.split(/\s+/)[0]).toUpperCase();
    }

    /* ===== Autoplay bootstrap ===== */
    document.addEventListener("DOMContentLoaded", async () => {
      try { bgVideo.muted = true; await bgVideo.play(); showStatus("state: video • playing"); }
      catch { showStatus("state: video • click to start"); document.addEventListener("click", ()=>bgVideo.play(),{once:true}); }
    });

    function setState(mode,msg=""){
      if(mode==="image"){ videoWrap.classList.add("hidden"); overlay.classList.add("visible"); try{bgVideo.pause();}catch{} }
      else { overlay.classList.remove("visible"); videoWrap.classList.remove("hidden"); bgVideo.muted=true; bgVideo.play().catch(()=>{}); }
      showStatus(`state: ${mode} • ${msg}`);
    }

    /* ===== Fit text to the bar (single line) ===== */
    function fitText(el){
      el.style.fontSize = ""; // reset to CSS
      const parent = el.parentElement;
      let size = parseFloat(getComputedStyle(el).fontSize);
      const min = 12;
      if (parent.clientWidth <= 0 || parent.clientHeight <= 0) return;
      while (size > min && (el.scrollWidth > parent.clientWidth || el.scrollHeight > parent.clientHeight)){
        size -= 1;
        el.style.fontSize = size + "px";
      }
    }

    /* ===== Show name for SHOW_MS ===== */
    let timer=null, showing=false, lastShownAt=0, lastName="";
    function showName(fullName){
      showing = true;
      const first = firstNameOf(fullName);
      nameEl.textContent = first;
      requestAnimationFrame(()=>fitText(nameEl));
      setState("image", `showing "${first}"`);
      clearTimeout(timer);
      lastShownAt = Date.now();
      lastName = fullName;
      timer = setTimeout(()=>{ setState("video","auto-revert"); showing=false; }, SHOW_MS);
    }

    /* ===== RTDB listener (string name) ===== */
    const refName = db.ref(WATCH_NAME);
    refName.on("value", snap=>{
      const raw = snap.val();
      console.log("[DB]", WATCH_NAME, "=>", raw);
      const name = (raw ?? "").toString().trim();
      if (!name){
        if (!overlay.classList.contains("visible")) setState("video","waiting…");
        return;
      }
      // show on any change
      if (name !== lastName) showName(name);
    }, err => { console.warn("[DB] error", err); showStatus("state: video • db error"); });

    /* ===== Poll fallback (re-show same name if rescanned) =====
       If your scanner writes the same string again, RTDB won't emit.
       This forces a re-show if the same name is set again after a few seconds.
    */
    setInterval(()=>{
      refName.get().then(snap=>{
        const name = (snap.val() ?? "").toString().trim();
        if (!name) return;
        const now = Date.now();
        if (name === lastName && now - lastShownAt > 3000 && !showing){
          showName(name);
        }
      }).catch(()=>{});
    }, 1500);

    /* Start */
    setState("video","listening…");

    /* Optional: turn on box debug with ?debug=1 */
    if (new URLSearchParams(location.search).get('debug')){
      document.querySelector('.name-box')?.classList.add('debug');
    }
  </script>
</body>
</html>
